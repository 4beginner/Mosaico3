- sysctl: name=net.bridge.bridge-nf-call-ip6tables value=1 state=present reload=yes sysctl_set=yes
- sysctl: name=net.bridge.bridge-nf-call-iptables value=1 state=present reload=yes sysctl_set=yes
- name: install flannel
  shell: >
    export KUBECONFIG=/etc/kubernetes/admin.conf ;
    curl --location "https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml" >/etc/kubectl/flannel.yml ;
    kubectl apply -f /etc/kubectl/flannel.yml
- shell: >
    export KUBECONFIG=/etc/kubernetes/admin.conf ;
    kubectl get pods -n kube-system -l app=flannel
  register: result
  until: result.stdout.find("Running") != -1
  retries: 100
  delay: 10
